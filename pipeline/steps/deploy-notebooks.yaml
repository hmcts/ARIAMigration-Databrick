parameters:
  env: ''
  pythonVersion: ''
  mainRepositoryName: ''
  databricksInstance: ''

steps:
- task: AzureCLI@2
  displayName: 'Deploy Notebook'
  inputs:
    azureSubscription: 'DTS-DATAINGEST-${{ upper(parameters.env) }}'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -e
      export PYTHONPATH="${PYTHONPATH}:/./"
      export DATABRICKS_HOST=${{ parameters.databricksInstance }}
      export DATABRICKS_TOKEN=$(AUTH-AccessToken-sbox)
      databricks bundle deploy --target ${{ parameters.env }} --output json > deploy_output.json
      job_id=$(jq -r '.resources.jobs.run-notebooks.id' deploy_output.json)
      echo "Job ID: $job_id"
      databricks jobs run-now --job-id $job_id
    workingDirectory: '$(System.DefaultWorkingDirectory)'