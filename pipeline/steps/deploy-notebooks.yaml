parameters:
  env: ''
  pythonVersion: ''
  mainRepositoryName: ''
  databricksInstance: ''
  runJob: ''
  subscriptionEndpoint: ''
  connection_string: ''

steps:
- task: AzureCLI@2
  displayName: 'Deploy Bundle'
  inputs:
    azureSubscription: ${{ parameters.subscriptionEndpoint }}
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -e
      echo "databricks instance is: ${{ parameters.databricksInstance }}"
      export PYTHONPATH="${PYTHONPATH}:/./"
      export DATABRICKS_HOST=${{ parameters.databricksInstance }}
      export DATABRICKS_TOKEN=$(AUTH-AccessToken-sbox)
      echo "Parameter.env is: ${{ parameters.env }}"
      echo "parameter.runJob is: ${{ parameters.runJob }}"
      databricks bundle deploy --target ${{ parameters.env }}
      if [ "${{ parameters.runJob }}" == True ]; then
        job_id=$(databricks jobs list | grep -w "run-notebooks" | awk '{print $1}' | head -n 1)
        echo "Job ID: $job_id"
        databricks jobs run-now $job_id
      else
        echo "Deployment successful. Skipping job execution."
      fi
    workingDirectory: '$(System.DefaultWorkingDirectory)'